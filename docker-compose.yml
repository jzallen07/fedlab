services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      [
        "python",
        "-m",
        "src.server.app",
        "--host",
        "0.0.0.0",
        "--port",
        "8080",
        "--rounds",
        "3",
        "--run-id",
        "docker-run",
        "--monitor-url",
        "http://monitor-api:8090",
      ]
    ports:
      - "8080:8080"
    volumes:
      - ./artifacts/server:/app/artifacts/server
    depends_on:
      - monitor-api

  client-1:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      [
        "python",
        "-m",
        "src.client.app",
        "start",
        "--server-address",
        "server:8080",
        "--client-id",
        "1",
        "--run-id",
        "docker-run",
        "--monitor-url",
        "http://monitor-api:8090",
      ]
    depends_on:
      - server

  client-2:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      [
        "python",
        "-m",
        "src.client.app",
        "start",
        "--server-address",
        "server:8080",
        "--client-id",
        "2",
        "--run-id",
        "docker-run",
        "--monitor-url",
        "http://monitor-api:8090",
      ]
    depends_on:
      - server

  client-3:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      [
        "python",
        "-m",
        "src.client.app",
        "start",
        "--server-address",
        "server:8080",
        "--client-id",
        "3",
        "--run-id",
        "docker-run",
        "--monitor-url",
        "http://monitor-api:8090",
      ]
    depends_on:
      - server

  monitor-api:
    build:
      context: .
      dockerfile: Dockerfile
    command:
      [
        "python",
        "-m",
        "src.monitor.app",
        "--host",
        "0.0.0.0",
        "--port",
        "8090",
        "--db-path",
        "/app/artifacts/monitor/monitor.db",
      ]
    ports:
      - "8090:8090"
    volumes:
      - ./artifacts/monitor:/app/artifacts/monitor

  dashboard:
    image: node:20-alpine
    working_dir: /workspace/apps/dashboard
    environment:
      VITE_MONITOR_PROXY_TARGET: http://monitor-api:8090
    command:
      ["sh", "-c", "npm ci && npm run dev -- --host 0.0.0.0 --port 5173"]
    ports:
      - "5173:5173"
    volumes:
      - .:/workspace
      - dashboard_node_modules:/workspace/apps/dashboard/node_modules
    depends_on:
      - monitor-api

volumes:
  dashboard_node_modules:
